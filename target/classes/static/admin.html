<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>SmartBus ‚Äî Crazy QR Generator</title>

    <!-- libs -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

    <style>
        :root{
          --bg1:#04091a; --bg2:#071b3a; --accent:#ff2d95; --accent2:#7c3aed;
          --glass: rgba(255,255,255,0.04);
          --muted: rgba(255,255,255,0.7);
        }
        *{box-sizing:border-box}
        body{
          margin:0;
          min-height:100vh;
          font-family: Inter, ui-sans-serif, system-ui;
          color:#fff;
          background:
            radial-gradient(600px 400px at 10% 20%, rgba(124,58,237,0.12), transparent),
            radial-gradient(800px 500px at 90% 80%, rgba(6,182,212,0.08), transparent),
            linear-gradient(180deg,var(--bg1),var(--bg2));
        }
        .blob{position:fixed;filter:blur(80px);opacity:0.75;z-index:0;pointer-events:none}
        .b1{width:420px;height:420px;left:-140px;top:-80px;background:radial-gradient(circle at 20% 30%, rgba(124,58,237,0.95), rgba(124,58,237,0.25));animation:float1 9s ease-in-out infinite}
        .b2{width:360px;height:360px;right:-120px;bottom:-120px;background:radial-gradient(circle at 70% 70%, rgba(6,182,212,0.9), rgba(6,182,212,0.18));animation:float2 11s ease-in-out infinite}

        @keyframes float1{0%{transform:translateY(0)}50%{transform:translateY(22px) rotate(2deg)}100%{transform:translateY(0)}}
        @keyframes float2{0%{transform:translateY(0)}50%{transform:translateY(-20px) rotate(-2deg)}100%{transform:translateY(0)}
        }
        .wrap{position:relative;z-index:1;max-width:1100px;margin:40px auto;padding:28px;display:grid;grid-template-columns: 1fr 420px;gap:26px}
        @media(max-width:980px){.wrap{grid-template-columns:1fr;padding:18px} .rightCol{order:-1}}
        .card{
          background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
          border:1px solid rgba(255,255,255,0.06);
          border-radius:14px;padding:22px;
          box-shadow:0 10px 40px rgba(2,6,23,0.6);
          backdrop-filter: blur(8px) saturate(140%);
        }
        header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px}
        header h1{font-size:20px;margin:0}
        header p{margin:0;color:var(--muted);font-size:13px}
        .formRow{display:flex;gap:12px;margin-bottom:12px}
        input[type="text"], input[type="date"]{
          flex:1;padding:12px;border-radius:10px;border:none;background:var(--glass);color:#fff;
          outline:none;font-size:14px
        }
        input::placeholder{color:rgba(255,255,255,0.45)}
        label.small{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
        .actions{display:flex;gap:12px;align-items:center;margin-top:10px}
        .btn{
          padding:11px 16px;border-radius:12px;border:none;cursor:pointer;font-weight:700;
          display:inline-flex;align-items:center;gap:10px;
        }
        .btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#fff;box-shadow:0 8px 28px rgba(124,58,237,0.18)}
        .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted)}
        .btn:active{transform:translateY(1px)}
        .muted{color:var(--muted);font-size:13px;margin-top:8px}
        .rightCol{display:flex;flex-direction:column;gap:16px;align-items:center;justify-content:flex-start}
        .previewCard{width:100%;display:flex;flex-direction:column;align-items:center;padding:18px;border-radius:12px;background:rgba(0,0,0,0.15);border:1px solid rgba(255,255,255,0.04)}
        footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px}
    </style>
</head>

<body>

<div class="blob b1"></div>
<div class="blob b2"></div>

<div class="wrap">

    <div class="card">
        <header>
            <div>
                <h1>üéõÔ∏è SmartBus ‚Äî QR Generator</h1>
                <p class="small">Create signed pass tokens & printable QR codes</p>
            </div>
            <button class="btn btn-ghost" onclick="goHome()">üè† Home</button>
        </header>

        <label class="small">Student USN</label>
        <div class="formRow">
            <input id="usn" type="text" placeholder="1NM20CS001">
            <input id="route" type="text" placeholder="Route R1 / R2">
        </div>

        <label class="small">Student Name</label>
        <div class="formRow">
            <input id="name" type="text" placeholder="Student Name">
        </div>

        <label class="small">Pass Expires</label>
        <div class="formRow">
            <input id="expires" type="date">
            <input id="issued" type="text" disabled>
        </div>

        <div class="actions">
            <button id="createBtn" class="btn btn-primary">‚ú® Generate Token</button>
            <button id="clearBtn" class="btn btn-ghost">üßπ Clear</button>
        </div>

        <div class="muted">Last Token:</div>
        <div id="tokenBox" style="padding:10px;background:#0003;border-radius:8px;font-family:monospace;word-wrap:anywhere;">
            (no token yet)
        </div>

        <div style="display:flex;gap:8px;margin-top:8px;">
            <button id="copyBtn" class="btn btn-ghost">Copy</button>
        </div>
    </div>

    <div class="rightCol">
        <div class="previewCard">
            <canvas id="qrCanvas" width="220" height="220" style="background:white;border-radius:10px"></canvas>

            <div style="color:#bbb;margin-top:10px;">Server QR</div>
            <img id="serverQrImg" style="width:200px;height:200px;background:white;border-radius:10px;">
        </div>

        <button id="quickScanBtn" class="btn btn-primary" style="width:100%">Open Scanner</button>

        <footer>NMAMIT ‚Ä¢ SmartBus</footer>
    </div>

</div>

<script>
/* Detect backend */
const isLocal = ["127.", "192.", "5500", "5501", "localhost"].some(x =>
    location.href.includes(x)
);
const BACKEND = isLocal ? "http://localhost:8080" : "";

/* Elements */
const usnEl = document.getElementById("usn");
const nameEl = document.getElementById("name");
const routeEl = document.getElementById("route");
const expiresEl = document.getElementById("expires");
const issuedEl = document.getElementById("issued");
const tokenBox = document.getElementById("tokenBox");
const qrCanvas = document.getElementById("qrCanvas");
const serverQrImg = document.getElementById("serverQrImg");

issuedEl.value = new Date().toISOString().slice(0,10);

/* Clear QR canvas */
function clearCanvas() {
    const ctx = qrCanvas.getContext("2d");
    ctx.fillStyle="#fff";
    ctx.fillRect(0,0,qrCanvas.width,qrCanvas.height);
}
clearCanvas();

/* Generate Token */
document.getElementById("createBtn").onclick = async () => {
    const usn = usnEl.value.trim();
    const name = nameEl.value.trim();
    const route = routeEl.value.trim();
    const expires = expiresEl.value;

    if(!usn || !expires){
        alert("USN & Expiry required");
        return;
    }

    try{
        const res = await fetch(`${BACKEND}/api/add-student`, {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body:JSON.stringify({ usn,name,route,expires })
        });

        const json = await res.json();

        if(json.token){
            tokenBox.textContent = json.token;

            clearCanvas();
            QRCode.toCanvas(qrCanvas, json.token, { width:220 });

            serverQrImg.src = `${BACKEND}/api/qr/${usn}?t=${Date.now()}`;
        }
    }catch(err){
        alert("Network error");
    }
};

/* Clear */
document.getElementById("clearBtn").onclick = () => {
    usnEl.value = "";
    nameEl.value = "";
    routeEl.value = "";
    expiresEl.value = "";
    tokenBox.textContent = "(no token yet)";
    serverQrImg.src = "";
    clearCanvas();
};

/* Copy */
document.getElementById("copyBtn").onclick = () => {
    navigator.clipboard.writeText(tokenBox.textContent);
    alert("Copied");
};

/* Scanner */
document.getElementById("quickScanBtn").onclick = () => {
    const base = location.href.split("/").slice(0, -1).join("/");
    location.href = base + "/scanner.html";
};

/* Home */
function goHome(){
    const base = location.href.split("/").slice(0, -1).join("/");
    location.href = base + "/index.html";
}
</script>

<!-- üî• BLOCK LIVE SERVER AUTO-RELOAD -->
<script>
(function() {
    let interval = setInterval(() => {

        /* Remove livereload script tags */
        document.querySelectorAll("script[src*='livereload'], script[src*='live-server']")
            .forEach(s => s.remove());

        /* Disconnect livereload websocket */
        try {
            if (window.LiveReload) window.LiveReload.disconnect();
        } catch(e){}

        /* Block websocket connections to livereload */
        if (window.WebSocket && !window.__wsBlocked) {
            window.__wsBlocked = true;
            const OldWS = window.WebSocket;
            window.WebSocket = function(url, protocols) {
                if (url && url.includes("livereload")) {
                    return { close(){}, send(){}, readyState:3 };
                }
                return new OldWS(url, protocols);
            };
        }

    }, 300);
})();
</script>

</body>
</html>
